# 文生图交互过程

图片 API 本身非常简单，下载文件储存图片也很简单，复杂的地方在于我们如何把这个图片适配到不同的设备上，保持它的显示效果。
这里需要数据库参与工作了，我们需要登记图片的生成和使用。
假设我们在聊天记录里面引用的是全尺寸的图片。这个图片在不同客户端获取的时候，根据这个客户端的需要，服务器实时转码缩放成对应的格式，然后返回给客户端。
那么客户端在 Client Hello 的时候需要报告自己的屏幕类型，适合怎样的图片。

对于这方面的开发，我们有几个方向：
第一个是关于图片的传输，我们如果已经有一个大尺寸的图片，
在客户端想要获取的时候能不能实时转换成小尺寸的图片。
第二个是大模型对于工具的调用，以及之后引用之前生成的对象的能力。

## 图片传输
我们先解决这个，因为客户端的显示效果是目前的工作重点。

用户发送一个 getBinaryObject 的请求，请求的核心是 bosid。
Esp 服务器得到 bosid 之后从 Api 服务器或者某种缓存里面得到对应的 BinaryObject 。
Esp 服务器发现这个 binary object 是一张图片。
服务器需要检查客户端的屏幕尺寸，以及图片的尺寸。
如果图片尺寸太大，那么计算缩放比例，压缩之后传递。
客户端得到图片之后要把它显示出来。

之前测试使用的推送消息格式非常简单：
`{ type='image', bosid }`
然后客户端发现自己没有对应 bosid 的资源之后就会发起请求资源：
`{ session_id, type='binary', state='query', bosid }`
然后服务器再把对应的资源用 Binary Packet 的形式发送给它。
客户端收到对应的资源之后会立刻刷新显示。

## 工具储存和图片生成

这个重点在于之前的数据库设计。

我感觉 LLM Helper 的类型外面还需要封装一层，一层用来自动根据事件把数据上传到数据库的过程。
比如说用于这个系统的 Tool Call 的函数就需要两种，
一种是内部输出数据的函数，一种是给 LLM 调用的函数。
我们先整理一个 Tool Call Typescript 文件，这个文件里面包含内部函数。
然后再用一个 Wrapper 类型，中间把 output 用 hook 传递，
然后 hook 里面做后台上传图片之类的交互，得到上传的结果之后把图片编号告诉 LLM。
这样 LLM 就可以之后使用这个编号引用这张图片调用其他的 Tool。
（这些工作已经完成了）

之后的一个问题是 Tool Call Table 的记录。
这个需要先解决 Tool Bind 之后才能解决哪些表格里面乱七八糟的关系。

还有悬而未决的是客户端上面的图片缩放问题，
我在想要不要把发两个 Binary Object Jpeg。
然后客户端在聊天记录里面显示一个小尺寸的
当用户点开图片的时候，解码那个大尺寸的。

两个 Binary Object 就会有 Bosid 的分配问题，
这个问题最粗暴的方法就是服务器那边就储存好许多不同尺寸的图片对应不同的 Bosid。

好一点的方法是请求图片用和下载文件不同的 Api ，请求图片的时候带上图片尺寸参数。
然后服务器把对应的尺寸发送下来，不同的尺寸使用不同的 Bosid，
在发送图片之前先告知客户端不同尺寸的 Bosid ，
这些是临时 Bosid 现场转换出来的图片，这个 Bosid 和对应的图片不会保存。
`{ type='image', state='resize', small='<temp bosid>', origin='<bosid>' } `

然后客户端记录这个 small origin 的映射关系 这里储存的时候要注意一点，
储存图片需要 `map<Bosid, [small, origin]>` 这样储存。
这样也可以解决图片尺寸的问题。而且这样看起来挺优雅的。





